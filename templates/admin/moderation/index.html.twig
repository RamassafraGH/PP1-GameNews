{# 
    Template: admin/moderation/index.html.twig

    Referencia a CU16 - Moderar comentarios
    
    Vista principal del panel de moderación de denuncias
    
    Funcionalidad:
    - Lista paginada de todos los reportes del sistema
    - Información detallada de cada reporte (denunciante, motivo, comentario, estado)
    - Filtrado visual mediante badges de color según motivo y estado
    - Acceso directo a la revisión de reportes pendientes
    - Manejo de reportes con comentarios eliminados (cascade delete)
    
    Características:
    - Diseño responsive con tabla scrolleable horizontal en móviles
    - Truncamiento de texto largo con tooltips informativos
    - Indicadores visuales de estado (pending, resolved, dismissed)
    - Paginación automática mediante KnpPaginatorBundle
    - Estado vacío personalizado cuando no hay reportes
    
    Seguridad:
    - Solo accesible para usuarios con ROLE_ADMIN
    - Controlada por el atributo IsGranted en ModerationController
    
    Integración:
    - Utiliza el sistema de cascade de Symfony/Doctrine
    - Muestra "Eliminado" cuando el comentario fue borrado (gracias a cascade remove)
    - Compatible con el flujo de moderación del ModerationController
#}

{% extends 'base.html.twig' %}

{% block title %}Moderación de Denuncias - GameNews{% endblock %}

{% block body %}
{# Header con título y navegación #}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <h1 class="mb-0">
        <i class="bi bi-shield-check"></i> Moderación de Denuncias
    </h1>
    <a href="{{ path('app_admin_dashboard') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver al Dashboard
    </a>
</div>

{# Card contenedor principal #}
<div class="card">
    <div class="card-body">
        {# 
            Tabla responsive de reportes
            - Diseño optimizado para diferentes tamaños de pantalla
            - Columnas con anchos mínimos para evitar colapso
        #}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th style="min-width: 50px;">ID</th>
                        <th style="min-width: 120px;">Denunciante</th>
                        <th style="min-width: 150px;">Motivo</th>
                        <th style="min-width: 200px;">Comentario</th>
                        <th style="min-width: 100px;">Estado</th>
                        <th style="min-width: 130px;">Fecha</th>
                        <th style="min-width: 120px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in pagination %}
                        <tr>
                            {# ID del reporte #}
                            <td>{{ report.id }}</td>
                            
                            {# 
                                Denunciante
                                - Truncado con tooltip para nombres largos
                                - Máximo 150px de ancho
                            #}
                            <td>
                                <span class="d-inline-block text-truncate" 
                                      style="max-width: 150px;" 
                                      title="{{ report.reporter.username }}">
                                    {{ report.reporter.username }}
                                </span>
                            </td>
                            
                            {# 
                                Motivo de la denuncia
                                - Badges de colores según el tipo de infracción
                                - Etiquetas traducidas al español
                            #}
                            <td>
                                <span class="badge 
                                    {% if report.reason == 'harassment' %}
                                        bg-danger
                                    {% elseif report.reason == 'spam' %}
                                        bg-warning text-dark
                                    {% elseif report.reason == 'offensive_language' %}
                                        bg-danger
                                    {% elseif report.reason == 'inappropriate_content' %}
                                        bg-warning text-dark
                                    {% else %}
                                        bg-secondary
                                    {% endif %}">
                                    {% if report.reason == 'inappropriate_content' %}
                                        Contenido Inapropiado
                                    {% elseif report.reason == 'offensive_language' %}
                                        Lenguaje Ofensivo
                                    {% elseif report.reason == 'harassment' %}
                                        Acoso
                                    {% elseif report.reason == 'spam' %}
                                        Spam
                                    {% else %}
                                        Otros
                                    {% endif %}
                                </span>
                            </td>
                            
                            {# 
                                Comentario reportado
                                - Muestra el contenido truncado con tooltip
                                - Maneja comentarios eliminados (cascade delete)
                                - Si el comentario fue eliminado, muestra "Eliminado"
                            #}
                            <td>
                                {% if report.comment %}
                                    <span class="d-inline-block text-truncate" 
                                          style="max-width: 250px;" 
                                          title="{{ report.comment.content }}">
                                        {{ report.comment.content }}
                                    </span>
                                {% else %}
                                    <span class="text-muted fst-italic">
                                        <i class="bi bi-trash"></i> Comentario eliminado
                                    </span>
                                {% endif %}
                            </td>
                            
                            {# 
                                Estado del reporte
                                - pending: Amarillo (requiere acción)
                                - resolved: Verde (comentario eliminado)
                                - dismissed: Gris (reporte descartado - ya no existe en BD con nuevo sistema)
                                
                                Nota: Con el nuevo sistema, los reportes dismissed se eliminan
                                de la BD, por lo que solo aparecen pending y resolved aquí
                            #}
                            <td>
                                {% if report.status == 'pending' %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock"></i> Pendiente
                                    </span>
                                {% elseif report.status == 'resolved' %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Resuelto
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-x-circle"></i> Descartado
                                    </span>
                                {% endif %}
                            </td>
                            
                            {# Fecha de creación del reporte #}
                            <td>
                                <small class="text-muted">
                                    {{ report.createdAt|date('d/m/Y H:i') }}
                                </small>
                            </td>
                            
                            {# 
                                Acciones disponibles
                                - Solo reportes pendientes pueden ser revisados
                                - Los resueltos/descartados muestran estado "Procesado"
                            #}
                            <td>
                                {% if report.status == 'pending' %}
                                    <a href="{{ path('app_admin_moderation_review', {id: report.id}) }}" 
                                       class="btn btn-sm btn-primary"
                                       title="Revisar y tomar acción sobre este reporte">
                                        <i class="bi bi-eye"></i> 
                                        <span class="d-none d-lg-inline">Revisar</span>
                                    </a>
                                {% else %}
                                    <span class="text-muted small">
                                        <i class="bi bi-check2"></i> Procesado
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        {# 
                            Estado vacío
                            - Se muestra cuando no hay reportes en el sistema
                            - Diseño centrado con ícono grande
                        #}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>
                                <p class="mb-0 mt-3 fs-5">No hay denuncias registradas</p>
                                <p class="small">Los reportes aparecerán aquí cuando los usuarios denuncien comentarios</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# 
            Paginación
            - Solo se muestra si hay elementos para paginar
            - Usa KnpPaginatorBundle
        #}
        {% if pagination.getTotalItemCount > 0 %}
            <div class="mt-4 d-flex justify-content-center">
                <nav aria-label="Paginación de reportes">
                    {{ knp_pagination_render(pagination) }}
                </nav>
            </div>
            
            {# Información de resultados #}
            <div class="text-center text-muted small mt-2">
                Mostrando 
                <strong>{{ pagination.getItemNumberPerPage * (pagination.getCurrentPageNumber - 1) + 1 }}</strong>
                -
                <strong>{{ min(pagination.getItemNumberPerPage * pagination.getCurrentPageNumber, pagination.getTotalItemCount) }}</strong>
                de 
                <strong>{{ pagination.getTotalItemCount }}</strong>
                {{ pagination.getTotalItemCount == 1 ? 'denuncia' : 'denuncias' }}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}